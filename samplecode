$ReportFile = "C:\Users\p10sh\Documents\ServiceStatus_$(get-date -f yyyy-MM-dd-HH-mm-ss).CSV"

#delete existing report file
Remove-item $ReportFile -ErrorAction SilentlyContinue

#Add header to the file
$str_op_service = "Computer Name, Service Name, Service Status"
Add-Content $ReportFile $str_op_service

#Fetch server and their services from JSON
$server_services = Get-Content "C:\Users\p10sh\Documents\services.json" | Out-String | ConvertFrom-Json

Foreach ($ComputerName in $server_services)
{
    $Error.Clear()
    Foreach($serviceNameToCheck in $ComputerName.value) {
        
        $ob_service = Get-WmiObject -Query "select * from win32_service where name='$serviceNameToCheck'" -ComputerName $ComputerName.name | Select-Object -Property PSComputerName, Name, State
        IF ($Error.Count -ne 0) {
            #unable to connect to remote server
            $str_op_service = $ComputerName.name+", "+$serviceNameToCheck+", Could Not Connect to Remote Computer"
        }
        else {
            #successfull connection with remote server
            if ($ob_service.PSComputerName) {
                #only when service is found on server
                $str_op_service = $ob_service.PSComputerName+", "+$ob_service.Name+", "+$ob_service.State
                
            } else {
                #only when service is not found on server
                $str_op_service = $ComputerName.name+", "+$serviceNameToCheck+", Service Not found"
            }
        }
        Add-Content $ReportFile $str_op_service
    }
    Add-Content $ReportFile ""
}
